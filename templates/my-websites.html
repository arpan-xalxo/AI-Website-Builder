<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Websites | AI Website Builder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    body {
      background: linear-gradient(135deg, #0f172a 70%, #facc15 30%);
      min-height: 100vh;
      padding-top: 5rem;
      color: #f1f5f9;
      font-family: 'Inter', sans-serif;
    }
    .websites-container {
      background-color: rgba(30, 41, 59, 0.75);
      backdrop-filter: blur(10px);
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .websites-title { font-size: 2rem; font-weight: 600; color: #facc15; }
    .title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .btn-generate { background-color: #facc15; border: none; color: #1e293b; font-weight: bold; padding: 0.6rem 1.2rem; border-radius: 8px; text-decoration: none; }
    .table { background: #334155; color: #e5e7eb; }
    thead th { background: #1e293b; color: #facc15; }
    .action-btn { margin-right: 0.5rem; background: #475569; color: #f1f5f9; border: 1px solid #64748b; border-radius: 6px; padding: 0.3rem 0.8rem; text-decoration: none; }
    .btn-delete { color: #f87171; border-color: #f87171; }
    .btn-delete:hover { background-color: #dc3545; color: #fff; border-color: #dc3545; }
  </style>
</head>
<body>
  <div class="websites-container">
    <div class="title-bar">
        <h3 class="websites-title">Websites</h3>
        <a href="/generate" class="btn btn-generate">+ Generate New</a>
    </div>
    <div id="websites-table-container" class="table-responsive">
      <div class="text-center p-5"><div class="spinner-border text-warning"></div></div>
    </div>
  </div>

  <script>
    let currentUser = null;

    async function fetchCurrentUser() {
        const token = localStorage.getItem('token');
        if (!token) return null;
        try {
            const res = await fetch('/api/dashboard', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) return null;
            const data = await res.json();
            return data.user;
        } catch (e) {
            return null;
        }
    }

    async function loadWebsites() {
      currentUser = await fetchCurrentUser();
      const token = localStorage.getItem('token');
      const container = document.getElementById('websites-table-container');

      if (!token || !currentUser) {
        container.innerHTML = '<div class="alert alert-danger">Please log in to view websites.</div>';
        return;
      }
      try {
        const res = await fetch('/websites', { headers: { 'Authorization': `Bearer ${token}` } });
        if (!res.ok) throw new Error('Failed to fetch websites.');
        
        const websites = await res.json();
        if (!websites.length) {
          container.innerHTML = '<div class="text-center p-5 text-secondary">No websites found.</div>';
          return;
        }

        let tableHtml = `<table class="table"><thead><tr><th>Name</th><th>Owner</th><th class="text-end">Actions</th></tr></thead><tbody>`;
        for (const w of websites) {
          const canEditOrDelete = currentUser.role === 'Admin' || currentUser.id === w.owner_id;

          tableHtml += `
            <tr>
              <td>${w.data?.metadata?.business_type || 'Untitled'}</td>
              <td>${w.owner_email || w.owner_id || '-'}</td>
              <td class="text-end">
                <a href="/preview/${w._id}?token=${token}" target="_blank" class="action-btn">üëÅÔ∏è Preview & Edit</a>
                ${canEditOrDelete ? `
                  <button class="action-btn btn-delete" onclick='deleteWebsite("${w._id}")'>üóëÔ∏è Delete</button>
                ` : ''}
              </td>
            </tr>`;
        }
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
      } catch (e) {
        container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }

    async function deleteWebsite(id) {
        if (!confirm('Are you sure you want to delete this website? This action cannot be undone.')) return;
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/websites/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.msg || 'Failed to delete website.');
            }
            loadWebsites(); // Refresh the list after deleting
        } catch (e) {
            alert(`Error: ${e.message}`);
        }
    }

    window.addEventListener('load', loadWebsites);
  </script>
</body>
</html>
