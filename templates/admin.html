<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | AI Website Builder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <style>
    body {
      background: linear-gradient(135deg, #0f172a 70%, #facc15 30%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start; 
      padding-top: 5rem;
      padding-bottom: 5rem;
      color: #f1f5f9;
      font-family: 'Inter', sans-serif;
    }
    .admin-container {
      background-color: rgba(30, 41, 59, 0.75);
      backdrop-filter: blur(10px);
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 900px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .admin-title {
      font-size: 2rem;
      font-weight: 600;
      color: #facc15;
    }
    .title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .btn-add {
      background-color: #facc15;
      border: none;
      color: #1e293b;
      font-weight: bold;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-add:hover {
      background-color: #eab308;
      transform: translateY(-2px);
    }
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    .table {
      background: #334155;
      color: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 0;
      border: 1px solid #475569;
    }
    th, td {
      padding: 1rem;
      text-align: left;
      vertical-align: middle;
      border-bottom: 1px solid #475569;
    }
    thead th {
      background: #1e293b;
      color: #facc15;
      font-weight: 600;
      border-bottom: 2px solid #475569;
    }
    tbody tr {
        transition: background-color 0.2s ease;
    }
    tbody tr:hover {
        background-color: #475569;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .action-btn {
      margin-right: 0.5rem;
      background: #475569;
      color: #f1f5f9;
      border: 1px solid #64748b;
      border-radius: 6px;
      padding: 0.3rem 0.8rem;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .action-btn:hover {
      background: #facc15;
      color: #1e293b;
      border-color: #facc15;
      transform: translateY(-1px);
    }
    .modal {
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #1e293b;
        border: 1px solid #475569;
        border-radius: 16px;
    }
    .modal-header {
        border-bottom: 1px solid #475569;
    }
    .modal-title {
        color: #facc15;
    }
    .form-control {
      background-color: #334155;
      border: 1px solid #475569;
      color: white;
    }
    .form-control:focus {
      background-color: #334155;
      border-color: #facc15;
      box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.25);
      color: white;
    }
    .btn-save {
      background-color: #facc15;
      border: none;
      color: #1e293b;
      font-weight: bold;
    }
    .btn-save:hover {
        background-color: #eab308;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="title-bar">
      <h3 class="admin-title">Admin Panel - Roles</h3>
      <button class="btn btn-add" onclick="showAddRoleForm()">+ Add New Role</button>
    </div>
    <div id="roles-table-container" class="table-responsive">
      <div class="text-center p-5">
        <div class="spinner-border text-warning" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  
  <div id="roleFormModal" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="roleFormTitle">Add Role</h5>
          <button type="button" class="btn-close btn-close-white" onclick="closeRoleForm()"></button>
        </div>
        <div class="modal-body">
          <form id="roleForm">
            <input type="hidden" id="roleId" />
            <div class="mb-3">
              <label for="roleName" class="form-label">Role Name</label>
              <input type="text" class="form-control" id="roleName" required />
            </div>
            <div class="mb-3">
              <label for="rolePermissions" class="form-label">Permissions (comma-separated)</label>
              <input type="text" class="form-control" id="rolePermissions" placeholder="e.g. view_websites,edit_own_website" />
            </div>
            <button type="submit" class="btn btn-save w-100 mt-2">Save Role</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  
  <div id="deleteConfirmModal" class="modal" tabindex="-1" style="display:none;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Deletion</h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeDeleteModal()"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this role? This action cannot be undone.</p>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const roleModal = new bootstrap.Modal(document.getElementById('roleFormModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    function showAddRoleForm() {
      document.getElementById('roleForm').reset();
      document.getElementById('roleFormTitle').textContent = 'Add New Role';
      document.getElementById('roleId').value = '';
      roleModal.show();
    }

    function showEditRoleForm(role) {
      document.getElementById('roleForm').reset();
      document.getElementById('roleFormTitle').textContent = `Edit Role: ${role.name}`;
      document.getElementById('roleName').value = role.name;
      document.getElementById('rolePermissions').value = (role.permissions || []).join(', ');
      
      document.getElementById('roleId').value = role._id;
      roleModal.show();
    }

    function closeRoleForm() {
      roleModal.hide();
    }

    function closeDeleteModal() {
        deleteModal.hide();
    }

    async function loadRoles() {
      const container = document.getElementById('roles-table-container');
      if (!token) {
        container.innerHTML = '<div class="alert alert-danger">Please log in as an administrator.</div>';
        return;
      }
      try {
        const res = await fetch('/roles', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) throw new Error('Failed to fetch roles. You may not have admin permissions.');
        
        const roles = await res.json();
        if (!roles.length) {
          container.innerHTML = '<div class="text-center p-5 text-secondary">No roles found.</div>';
          return;
        }

        let tableHtml = `
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Permissions</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>`;
        for (const r of roles) {
          tableHtml += `
            <tr>
              <td>${r.name}</td>
              <td>${(r.permissions || []).join(', ')}</td>
              <td class="text-end">
                <button class="action-btn" onclick='showEditRoleForm(${JSON.stringify(r)})'>‚úèÔ∏è Edit</button>
                <button class="action-btn" onclick='confirmDeleteRole("${r._id}")'>üóëÔ∏è Delete</button>
              </td>
            </tr>`;
        }
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
      } catch (e) {
        container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }

    document.getElementById('roleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('roleName').value;
      const permissions = document.getElementById('rolePermissions').value.split(',').map(s => s.trim()).filter(Boolean);
      const id = document.getElementById('roleId').value;
      const method = id ? 'PUT' : 'POST';
      const url = id ? `/roles/${id}` : '/roles';

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, permissions })
        });
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.msg || 'Failed to save role.');
        }
        closeRoleForm();
        loadRoles();
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    });

    function confirmDeleteRole(id) {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.onclick = () => deleteRole(id);
        deleteModal.show();
    }

    async function deleteRole(id) {
      try {
        const res = await fetch(`/roles/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to delete role.');
        closeDeleteModal();
        loadRoles();
      } catch (e) {
        alert(`Error: ${e.message}`);
      }
    }

    window.addEventListener('load', loadRoles);
  </script>
</body>
</html>
